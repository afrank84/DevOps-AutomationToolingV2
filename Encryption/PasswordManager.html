<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üîê Local Password Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .masked { font-family: monospace; }
    td .btn { margin-left: 4px; }
  </style>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h2 class="mb-4">üîê Local Password Manager</h2>

    <!-- Upload + password -->
    <div class="mb-3">
      <input type="file" class="form-control" id="fileInput" />
    </div>
    <div class="mb-3">
      <input type="password" class="form-control" id="password" placeholder="Enter master password" />
    </div>
    <div class="mb-4 d-grid gap-2">
      <button class="btn btn-primary" id="decryptBtn">Decrypt File</button>
      <button class="btn btn-secondary" id="newVaultBtn">Start New Vault</button>
    </div>

    <!-- Add Entry + Save (top) -->
    <div class="d-none" id="addSectionTop">
      <div class="mb-4">
        <h4>Add New Entry</h4>
        <div class="row g-2 mb-2">
          <div class="col-md-3">
            <select class="form-select" id="entryType">
              <option value="login">Login</option>
              <option value="wifi">Wi-Fi</option>
              <option value="pat_token">PAT Token</option>
            </select>
          </div>
        </div>
        <div id="dynamicFields"></div>
        <div class="d-grid mt-2">
          <button class="btn btn-success" id="addEntryBtn">Add Entry</button>
        </div>
      </div>
      <div class="mb-4">
        <button class="btn btn-outline-secondary w-100" id="downloadBtn">üíæ Save Encrypted File</button>
      </div>
    </div>

    <!-- Search -->
    <div class="mb-3 d-none" id="controls">
      <input type="text" class="form-control" id="searchInput" placeholder="Search..." />
    </div>

    <!-- Table -->
    <table class="table table-bordered table-striped d-none" id="passwordTable">
      <thead>
        <tr>
          <th>Type</th>
          <th>Label / Summary</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const fieldTemplates = {
      login: `
        <div class="row g-2">
          <div class="col-md-4"><input type="text" class="form-control" id="site" placeholder="Site" /></div>
          <div class="col-md-4"><input type="text" class="form-control" id="username" placeholder="Username" /></div>
          <div class="col-md-4"><input type="text" class="form-control" id="passwordField" placeholder="Password" /></div>
        </div>`,
      wifi: `
        <div class="row g-2">
          <div class="col-md-6"><input type="text" class="form-control" id="label" placeholder="Label (e.g. Home Wi-Fi)" /></div>
          <div class="col-md-3"><input type="text" class="form-control" id="ssid" placeholder="SSID" /></div>
          <div class="col-md-3"><input type="text" class="form-control" id="wifiPassword" placeholder="Password" /></div>
        </div>`,
      pat_token: `
        <div class="row g-2">
          <div class="col-md-6"><input type="text" class="form-control" id="label" placeholder="Label (e.g. GitHub Token)" /></div>
          <div class="col-md-6"><input type="text" class="form-control" id="token" placeholder="Token" /></div>
        </div>`
    };

    document.getElementById("entryType").addEventListener("change", updateDynamicForm);
    function updateDynamicForm() {
      const type = document.getElementById("entryType").value;
      document.getElementById("dynamicFields").innerHTML = fieldTemplates[type] || "";
    }
    updateDynamicForm();

    async function getKeyFromPassword(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
      return await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function decryptData(buffer, password) {
      const salt = buffer.slice(0, 16);
      const iv = buffer.slice(16, 28);
      const data = buffer.slice(28);
      const key = await getKeyFromPassword(password, salt);
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
      return new TextDecoder().decode(decrypted);
    }

    async function encryptData(data, password) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await getKeyFromPassword(password, salt);
      const encoded = new TextEncoder().encode(data);
      const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, encoded);
      return new Uint8Array([...salt, ...iv, ...new Uint8Array(encrypted)]);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#passwordTable tbody");
      tbody.innerHTML = "";
      data.forEach((row, index) => {
        let summary = "";
        if (row.type === "login") summary = `${row.site} / ${row.username}`;
        else if (row.type === "wifi") summary = `SSID: ${row.ssid}`;
        else if (row.type === "pat_token") summary = `${row.token.slice(0, 4)}********`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.type}</td>
          <td>${row.label || row.site || "(No Label)"} - ${summary}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary" onclick="copyEntry(${index})">üìã Copy</button>
            <button class="btn btn-sm btn-warning" onclick="editEntry(${index})">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteEntry(${index})">üóëÔ∏è</button>
          </td>`;
        tbody.appendChild(tr);
      });
      document.getElementById("passwordTable").classList.remove("d-none");
      document.getElementById("controls").classList.remove("d-none");
      document.getElementById("addSectionTop").classList.remove("d-none");
    }

    function copyEntry(index) {
      const entry = window.fullData[index];
      navigator.clipboard.writeText(JSON.stringify(entry)).then(() => alert("Copied!"));
    }

    function editEntry(index) {
      alert("Edit not implemented yet for custom types.");
    }

    function deleteEntry(index) {
      if (confirm("Delete entry?")) {
        window.fullData.splice(index, 1);
        renderTable(window.fullData);
      }
    }

    document.getElementById("decryptBtn").addEventListener("click", () => {
      const file = document.getElementById("fileInput").files[0];
      const password = document.getElementById("password").value;
      if (!file || !password) return alert("Choose a file and enter password.");

      const reader = new FileReader();
      reader.onload = async function () {
        try {
          const buffer = new Uint8Array(reader.result);
          const result = await decryptData(buffer, password);
          window.fullData = JSON.parse(result);
          window.currentPassword = password;
          renderTable(window.fullData);
        } catch {
          alert("Failed to decrypt file.");
        }
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById("newVaultBtn").addEventListener("click", () => {
      if (!document.getElementById("password").value) {
        return alert("Please enter a password for your new vault.");
      }
      window.fullData = [];
      window.currentPassword = document.getElementById("password").value;
      renderTable(window.fullData);
    });

    document.getElementById("searchInput").addEventListener("input", function () {
      const q = this.value.toLowerCase();
      const filtered = window.fullData.filter(row =>
        Object.values(row).some(val => val.toString().toLowerCase().includes(q))
      );
      renderTable(filtered);
    });

    document.getElementById("addEntryBtn").addEventListener("click", () => {
      const type = document.getElementById("entryType").value;
      let newEntry = { type };
      if (type === "login") {
        newEntry.site = document.getElementById("site").value.trim();
        newEntry.username = document.getElementById("username").value.trim();
        newEntry.password = document.getElementById("passwordField").value.trim();
        if (!newEntry.site || !newEntry.username || !newEntry.password) return alert("All login fields required.");
      } else if (type === "wifi") {
        newEntry.label = document.getElementById("label").value.trim();
        newEntry.ssid = document.getElementById("ssid").value.trim();
        newEntry.password = document.getElementById("wifiPassword").value.trim();
        if (!newEntry.label || !newEntry.ssid || !newEntry.password) return alert("All Wi-Fi fields required.");
      } else if (type === "pat_token") {
        newEntry.label = document.getElementById("label").value.trim();
        newEntry.token = document.getElementById("token").value.trim();
        if (!newEntry.label || !newEntry.token) return alert("All PAT fields required.");
      }
      window.fullData.push(newEntry);
      renderTable(window.fullData);
    });

    document.getElementById("downloadBtn").addEventListener("click", async () => {
      const json = JSON.stringify(window.fullData);
      const encrypted = await encryptData(json, window.currentPassword);
      const blob = new Blob([encrypted], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "passwords.enc";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
