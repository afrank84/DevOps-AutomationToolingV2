<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🔐 Local Password Manager</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; max-width: 800px; }
    input, button, select { margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; vertical-align: middle; }
    th { cursor: pointer; background-color: #f0f0f0; }
    #searchInput { width: 100%; margin-top: 1rem; padding: 0.5rem; }
    .hidden { display: none; }
    td button { margin-left: 0.25rem; cursor: pointer; font-size: 0.9em; }
    .masked { font-family: monospace; }
    #addForm input { width: calc(100% - 1rem); }
    .actions { white-space: nowrap; }
  </style>
</head>
<body>
  <h2>🔐 Local Password Manager</h2>

  <input type="file" id="fileInput" />
  <input type="password" id="password" placeholder="Enter decryption password" />
  <button id="decryptBtn">Decrypt and Show Passwords</button>

  <input type="text" id="searchInput" placeholder="Search..." class="hidden" />

  <table id="passwordTable" class="hidden">
    <thead>
      <tr>
        <th data-key="site">Site</th>
        <th data-key="username">Username</th>
        <th data-key="password">Password</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="addForm" class="hidden">
    <h3>Add New Entry</h3>
    <input type="text" id="newSite" placeholder="Site" />
    <input type="text" id="newUsername" placeholder="Username" />
    <input type="text" id="newPassword" placeholder="Password" />
    <button id="addEntryBtn">Add Entry</button>
  </div>

  <script>
    async function getKeyFromPassword(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
      return await crypto.subtle.deriveKey({
        name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256"
      }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["decrypt"]);
    }

    async function decryptData(encryptedBuffer, password) {
      const salt = encryptedBuffer.slice(0, 16);
      const iv = encryptedBuffer.slice(16, 28);
      const data = encryptedBuffer.slice(28);
      const key = await getKeyFromPassword(password, salt);
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
      return new TextDecoder().decode(decrypted);
    }

    function renderTable(data) {
      const table = document.getElementById("passwordTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      data.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.site}<button onclick="copyToClipboard('${row.site}')">📋</button></td>
          <td>${row.username}<button onclick="copyToClipboard('${row.username}')">📋</button></td>
          <td>
            <span id="pw-${index}" class="masked">••••••••</span>
            <button onclick="togglePassword(${index}, '${row.password}')">👁️</button>
            <button onclick="copyToClipboard('${row.password}')">📋</button>
          </td>
          <td class="actions">
            <button onclick="editEntry(${index})">✏️</button>
            <button onclick="deleteEntry(${index})">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("searchInput").classList.remove("hidden");
      table.classList.remove("hidden");
      document.getElementById("addForm").classList.remove("hidden");
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
    }

    function togglePassword(index, password) {
      const span = document.getElementById(`pw-${index}`);
      if (span.classList.contains("masked")) {
        span.textContent = password;
        span.classList.remove("masked");
      } else {
        span.textContent = "••••••••";
        span.classList.add("masked");
      }
    }

    function filterTable(data, query) {
      return data.filter(row =>
        Object.values(row).some(value =>
          value.toLowerCase().includes(query.toLowerCase())
        )
      );
    }

    function sortTable(data, key, ascending) {
      return data.slice().sort((a, b) =>
        ascending ? a[key].localeCompare(b[key]) : b[key].localeCompare(a[key])
      );
    }

    function editEntry(index) {
      const entry = window.fullData[index];
      const newSite = prompt("Edit Site:", entry.site);
      const newUsername = prompt("Edit Username:", entry.username);
      const newPassword = prompt("Edit Password:", entry.password);
      if (newSite && newUsername && newPassword) {
        window.fullData[index] = { site: newSite, username: newUsername, password: newPassword };
        renderTable(window.fullData);
      }
    }

    function deleteEntry(index) {
      if (confirm("Are you sure you want to delete this entry?")) {
        window.fullData.splice(index, 1);
        renderTable(window.fullData);
      }
    }

    document.getElementById("decryptBtn").addEventListener("click", async () => {
      const file = document.getElementById("fileInput").files[0];
      const password = document.getElementById("password").value;
      if (!file || !password) return alert("Please select a file and enter password");

      const reader = new FileReader();
      reader.onload = async function () {
        try {
          const buffer = new Uint8Array(reader.result);
          const result = await decryptData(buffer, password);
          window.fullData = JSON.parse(result);
          renderTable(window.fullData);
        } catch {
          alert("Decryption failed or data is not valid.");
        }
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById("searchInput").addEventListener("input", function () {
      const filtered = filterTable(window.fullData, this.value);
      renderTable(filtered);
    });

    let sortDirection = {};
    document.querySelectorAll("#passwordTable th[data-key]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.key;
        sortDirection[key] = !sortDirection[key];
        const sorted = sortTable(window.fullData, key, sortDirection[key]);
        renderTable(sorted);
      });
    });

    document.getElementById("addEntryBtn").addEventListener("click", () => {
      const site = document.getElementById("newSite").value.trim();
      const username = document.getElementById("newUsername").value.trim();
      const password = document.getElementById("newPassword").value.trim();
      if (site && username && password) {
        window.fullData.push({ site, username, password });
        renderTable(window.fullData);
        document.getElementById("newSite").value = "";
        document.getElementById("newUsername").value = "";
        document.getElementById("newPassword").value = "";
      } else {
        alert("All fields are required to add a new entry.");
      }
    });
  </script>
</body>
</html>
