<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🔐 Local Password Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .masked { font-family: monospace; }
    td .btn { margin-left: 4px; }
  </style>
</head>
<body class="bg-light p-4">

  <div class="container">
    <h2 class="mb-4">🔐 Local Password Manager</h2>

    <!-- Upload + password -->
    <div class="mb-3">
      <input type="file" class="form-control" id="fileInput" />
    </div>
    <div class="mb-3">
      <input type="password" class="form-control" id="password" placeholder="Enter decryption password" />
    </div>
    <div class="mb-4 d-grid">
      <button class="btn btn-primary" id="decryptBtn">Decrypt and Show Passwords</button>
    </div>

    <!-- Add form + Save button (top!) -->
    <div class="d-none" id="addSectionTop">
      <div class="mb-4" id="addForm">
        <h4>Add New Entry</h4>
        <div class="row g-2">
          <div class="col-md-3">
            <input type="text" class="form-control" id="newSite" placeholder="Site" />
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="newUsername" placeholder="Username" />
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="newPassword" placeholder="Password" />
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-success" id="addEntryBtn">Add Entry</button>
          </div>
        </div>
      </div>

      <div class="mb-4" id="saveSection">
        <button class="btn btn-outline-secondary w-100" id="downloadBtn">💾 Save Encrypted File</button>
      </div>
    </div>

    <!-- Search -->
    <div class="mb-3 d-none" id="controls">
      <input type="text" class="form-control" id="searchInput" placeholder="Search..." />
    </div>

    <!-- Table -->
    <table class="table table-bordered table-striped d-none" id="passwordTable">
      <thead>
        <tr>
          <th data-key="site">Site</th>
          <th data-key="username">Username</th>
          <th data-key="password">Password</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function getKeyFromPassword(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
      return await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function decryptData(encryptedBuffer, password) {
      const salt = encryptedBuffer.slice(0, 16);
      const iv = encryptedBuffer.slice(16, 28);
      const data = encryptedBuffer.slice(28);
      const key = await getKeyFromPassword(password, salt);
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
      return new TextDecoder().decode(decrypted);
    }

    async function encryptData(data, password) {
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await getKeyFromPassword(password, salt);
      const encoded = new TextEncoder().encode(data);
      const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, encoded);
      return new Uint8Array([...salt, ...iv, ...new Uint8Array(encrypted)]);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#passwordTable tbody");
      tbody.innerHTML = "";
      data.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.site}<button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${row.site}')">📋</button></td>
          <td>${row.username}<button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${row.username}')">📋</button></td>
          <td>
            <span id="pw-${index}" class="masked">••••••••</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="togglePassword(${index}, '${row.password}')">👁️</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${row.password}')">📋</button>
          </td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editEntry(${index})">✏️</button>
            <button class="btn btn-sm btn-danger" onclick="deleteEntry(${index})">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("passwordTable").classList.remove("d-none");
      document.getElementById("controls").classList.remove("d-none");
      document.getElementById("addSectionTop").classList.remove("d-none");
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
    }

    function togglePassword(index, password) {
      const span = document.getElementById(`pw-${index}`);
      if (span.classList.contains("masked")) {
        span.textContent = password;
        span.classList.remove("masked");
      } else {
        span.textContent = "••••••••";
        span.classList.add("masked");
      }
    }

    function filterTable(data, query) {
      return data.filter(row =>
        Object.values(row).some(value =>
          value.toLowerCase().includes(query.toLowerCase())
        )
      );
    }

    function sortTable(data, key, ascending) {
      return data.slice().sort((a, b) =>
        ascending ? a[key].localeCompare(b[key]) : b[key].localeCompare(a[key])
      );
    }

    function editEntry(index) {
      const entry = window.fullData[index];
      const newSite = prompt("Edit Site:", entry.site);
      const newUsername = prompt("Edit Username:", entry.username);
      const newPassword = prompt("Edit Password:", entry.password);
      if (newSite && newUsername && newPassword) {
        window.fullData[index] = { site: newSite, username: newUsername, password: newPassword };
        renderTable(window.fullData);
      }
    }

    function deleteEntry(index) {
      if (confirm("Delete this entry?")) {
        window.fullData.splice(index, 1);
        renderTable(window.fullData);
      }
    }

    document.getElementById("decryptBtn").addEventListener("click", async () => {
      const file = document.getElementById("fileInput").files[0];
      const password = document.getElementById("password").value;
      if (!file || !password) return alert("Select a file and enter password.");

      const reader = new FileReader();
      reader.onload = async function () {
        try {
          const buffer = new Uint8Array(reader.result);
          const result = await decryptData(buffer, password);
          window.fullData = JSON.parse(result);
          window.currentPassword = password;
          renderTable(window.fullData);
        } catch {
          alert("Decryption failed.");
        }
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById("searchInput").addEventListener("input", function () {
      const filtered = filterTable(window.fullData, this.value);
      renderTable(filtered);
    });

    let sortDirection = {};
    document.querySelectorAll("#passwordTable th[data-key]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.dataset.key;
        sortDirection[key] = !sortDirection[key];
        const sorted = sortTable(window.fullData, key, sortDirection[key]);
        renderTable(sorted);
      });
    });

    document.getElementById("addEntryBtn").addEventListener("click", () => {
      const site = document.getElementById("newSite").value.trim();
      const username = document.getElementById("newUsername").value.trim();
      const password = document.getElementById("newPassword").value.trim();
      if (site && username && password) {
        window.fullData.push({ site, username, password });
        renderTable(window.fullData);
        document.getElementById("newSite").value = "";
        document.getElementById("newUsername").value = "";
        document.getElementById("newPassword").value = "";
      } else {
        alert("All fields are required.");
      }
    });

    document.getElementById("downloadBtn").addEventListener("click", async () => {
      const json = JSON.stringify(window.fullData);
      const encrypted = await encryptData(json, window.currentPassword);
      const blob = new Blob([encrypted], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "passwords.enc";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
