name: Update Secrets in Other Repo

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Load Repo A secrets
        id: secrets
        run: |
          echo "secret_names=$(jq -n 'env' | jq 'keys')" >> $GITHUB_OUTPUT

      - name: Update Repo B secrets
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.UPDATER_PAT }}
          script: |
            const owner = "YOUR_OWNER";
            const targetRepo = "TARGET_REPO";

            const secretsToSync = ["SECRET_ONE", "SECRET_TWO"]; 
            // You manually list them OR generate this list

            for (const name of secretsToSync) {
              const value = process.env[name];

              if (!value) {
                console.log(`Skipping ${name}, no value found in Repo A`);
                continue;
              }

              // Get Repo B public key
              const { data: pubkey } = await github.request(
                'GET /repos/{owner}/{repo}/actions/secrets/public-key',
                { owner, repo: targetRepo }
              );

              // Encrypt with libsodium
              const sodium = require('libsodium-wrappers');
              await sodium.ready;
              const encrypted = sodium.crypto_box_seal(
                value,
                Buffer.from(pubkey.key, 'base64')
              );

              // Update secret in Repo B
              await github.request(
                'PUT /repos/{owner}/{repo}/actions/secrets/{secret_name}',
                {
                  owner,
                  repo: targetRepo,
                  secret_name: name,
                  encrypted_value: encrypted.toString('base64'),
                  key_id: pubkey.key_id
                }
              );

              console.log(`Updated ${name} in ${targetRepo}`);
            }
