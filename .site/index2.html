<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DevOps Automation Tooling – Code Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Markdown renderer for .md files -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #0f172a;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      max-width: 40vw;
      background: #020617;
      border-right: 1px solid #1f2937;
      padding: 1rem;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .sidebar h1 {
      font-size: 1.1rem;
      margin: 0 0 0.75rem;
      color: #f9fafb;
    }

    .sidebar small {
      display: block;
      color: #9ca3af;
      margin-bottom: 0.75rem;
    }

    .file-search {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
      margin-bottom: 0.75rem;
    }

    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.85rem;
    }

    .file-item {
      margin-bottom: 0.15rem;
    }

    .file-link {
      cursor: pointer;
      display: block;
      border-radius: 0.25rem;
      padding: 0.25rem 0.35rem;
      color: #e5e7eb;
      text-decoration: none;
      border: 1px solid transparent;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-link:hover {
      background: #111827;
      border-color: #1f2937;
    }

    .file-link.active {
      background: #111827;
      border-color: #4b5563;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-height: 100vh;
    }

    .topbar {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #1f2937;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      box-sizing: border-box;
    }

    .topbar-title {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .topbar-repo {
      color: #9ca3af;
      font-size: 0.8rem;
    }

    .status {
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: right;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      box-sizing: border-box;
    }

    .file-section {
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: #020617;
      margin-bottom: 1rem;
      overflow: hidden;
    }

    .file-header {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .file-path {
      font-size: 0.85rem;
      color: #e5e7eb;
      margin-right: 0.5rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-meta {
      font-size: 0.75rem;
      color: #9ca3af;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .toggle-indicator {
      font-size: 0.9rem;
      margin-left: 0.5rem;
      color: #9ca3af;
    }

    /* Generic code blocks */
    pre {
      margin: 0;
      padding: 0.75rem;
      background: #020617;
      color: #e5e7eb;
      overflow-x: auto;
      font-size: 0.8rem;
      line-height: 1.45;
      white-space: pre-wrap;   /* key: preserve indentation & wrapping */
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;   /* preserve Markdown spacing */
      word-break: break-word;
    }

    .hidden {
      display: none;
    }

    .error {
      padding: 0.75rem;
      border-radius: 0.5rem;
      background: #450a0a;
      border: 1px solid #7f1d1d;
      color: #fecaca;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .hint {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.3rem;
    }

    /* Markdown rendering for .md files */
    .markdown {
      padding: 0.9rem 1rem;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .markdown h1,
    .markdown h2,
    .markdown h3,
    .markdown h4 {
      margin: 0.6rem 0 0.4rem;
      font-weight: 600;
    }

    .markdown h1 { font-size: 1.3rem; }
    .markdown h2 { font-size: 1.15rem; }
    .markdown h3 { font-size: 1rem; }

    .markdown p {
      margin: 0.35rem 0 0.5rem;
    }

    .markdown ul,
    .markdown ol {
      padding-left: 1.4rem;
      margin: 0.35rem 0 0.6rem;
    }

    .markdown li {
      margin: 0.15rem 0;
    }

    .markdown code {
      background: #1e293b;
      padding: 0.1rem 0.25rem;
      border-radius: 0.25rem;
      font-size: 0.85em;
    }

    .markdown pre {
      background: #111827;
      padding: 0.75rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      white-space: pre;
      margin: 0.5rem 0;
    }

    .markdown pre code {
      background: transparent;
      padding: 0;
      border-radius: 0;
      white-space: pre;
      font-size: 0.8rem;
      line-height: 1.45;
    }

    .markdown hr {
      border: none;
      border-top: 1px solid #1f2937;
      margin: 0.75rem 0;
    }

    a,
    .markdown a {
      color: #60a5fa;
      text-decoration: none;
    }

    a:hover,
    .markdown a:hover {
      text-decoration: underline;
    }

    @media (max-width: 800px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        max-width: 100%;
        border-right: none;
        border-bottom: 1px solid #1f2937;
      }
      .main {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>DevOps Automation Tooling</h1>
    <small>Live code browser for the GitHub repo.</small>

    <input
      id="fileSearch"
      class="file-search"
      type="search"
      placeholder="Filter files (e.g. ps1, Docker, yaml)"
      autocomplete="off"
    />

    <ul id="fileList" class="file-list"></ul>

    <div class="hint">
      Tip: Click a file name here to scroll to it in the code view.
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <div class="topbar-title">All repository files</div>
        <div class="topbar-repo">
          Source: github.com/afrank84/DevOps-AutomationToolingV2
        </div>
      </div>
      <div class="status" id="status">Loading tree…</div>
    </div>

    <div id="content" class="content"></div>
  </main>

  <script>
    // Repo configuration
    const owner = "afrank84";
    const repo = "DevOps-AutomationToolingV2";
    const branch = "main";

    const excludedExtensions = [
      ".png", ".jpg", ".jpeg", ".gif", ".ico",
      ".pdf", ".zip", ".gz", ".7z", ".exe",
      ".dll", ".so", ".pdb"
    ];

    const statusEl = document.getElementById("status");
    const contentEl = document.getElementById("content");
    const fileListEl = document.getElementById("fileList");
    const fileSearchEl = document.getElementById("fileSearch");

    let allFiles = [];

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function isExcluded(path) {
      const lower = path.toLowerCase();
      return excludedExtensions.some(ext => lower.endsWith(ext));
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(res.status + " " + res.statusText + " while fetching " + url);
      }
      return res.json();
    }

    async function fetchText(url) {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(res.status + " " + res.statusText + " while fetching " + url);
      }
      return res.text();
    }

    function createFileSection(path, index) {
      const section = document.createElement("section");
      section.className = "file-section";
      section.id = "file-" + index;

      const header = document.createElement("div");
      header.className = "file-header";

      const pathEl = document.createElement("div");
      pathEl.className = "file-path";
      pathEl.textContent = path;

      const metaEl = document.createElement("div");
      metaEl.className = "file-meta";
      metaEl.innerHTML = `<span class="toggle-indicator">[collapse]</span>`;

      header.appendChild(pathEl);
      header.appendChild(metaEl);

      const bodyWrapper = document.createElement("div");
      // For non-markdown, we'll insert <pre><code>; for markdown we'll replace with .markdown

      const pre = document.createElement("pre");
      const code = document.createElement("code");
      code.textContent = "Loading " + path + "…";
      pre.appendChild(code);
      bodyWrapper.appendChild(pre);

      header.addEventListener("click", () => {
        const collapsed = bodyWrapper.classList.toggle("hidden");
        const indicator = metaEl.querySelector(".toggle-indicator");
        indicator.textContent = collapsed ? "[expand]" : "[collapse]";
      });

      section.appendChild(header);
      section.appendChild(bodyWrapper);

      return { section, codeEl: code, bodyWrapper };
    }

    function populateSidebar(files) {
      fileListEl.innerHTML = "";
      files.forEach((file, idx) => {
        const li = document.createElement("li");
        li.className = "file-item";

        const a = document.createElement("a");
        a.className = "file-link";
        a.textContent = file.path;
        a.href = "#file-" + idx;
        a.addEventListener("click", (e) => {
          e.preventDefault();
          document
            .querySelectorAll(".file-link.active")
            .forEach(el => el.classList.remove("active"));
          a.classList.add("active");
          const target = document.getElementById("file-" + idx);
          if (target) {
            target.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });

        li.appendChild(a);
        fileListEl.appendChild(li);
      });
    }

    function applyFileFilter() {
      const term = fileSearchEl.value.toLowerCase().trim();
      const items = fileListEl.querySelectorAll(".file-item");
      items.forEach((li, idx) => {
        const file = allFiles[idx];
        const match = !term || file.path.toLowerCase().includes(term);
        li.style.display = match ? "" : "none";
        const section = document.getElementById("file-" + idx);
        if (section) section.style.display = match ? "" : "none";
      });
    }

    fileSearchEl.addEventListener("input", applyFileFilter);

    async function init() {
      try {
        setStatus("Fetching repository tree…");
        const treeUrl =
          "https://api.github.com/repos/" +
          owner +
          "/" +
          repo +
          "/git/trees/" +
          encodeURIComponent(branch) +
          "?recursive=1";

        const treeData = await fetchJson(treeUrl);
        if (!treeData.tree) {
          throw new Error("Unexpected tree response");
        }

        const files = treeData.tree
          .filter(item => item.type === "blob")
          .filter(item => !isExcluded(item.path))
          .sort((a, b) => a.path.localeCompare(b.path));

        allFiles = files;

        if (files.length === 0) {
          setStatus("No files found in tree.");
          return;
        }

        setStatus("Found " + files.length + " files. Loading content…");

        populateSidebar(files);

        const fileSections = [];
        files.forEach((file, idx) => {
          const { section, codeEl, bodyWrapper } = createFileSection(file.path, idx);
          contentEl.appendChild(section);
          fileSections[idx] = { codeEl, bodyWrapper, path: file.path };
        });

        let loaded = 0;
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const rawUrl =
            "https://raw.githubusercontent.com/" +
            owner +
            "/" +
            repo +
            "/" +
            encodeURIComponent(branch) +
            "/" +
            file.path;

          try {
            const text = await fetchText(rawUrl);
            const sectionInfo = fileSections[i];

            if (file.path.toLowerCase().endsWith(".md")) {
              // Render Markdown instead of raw text
              const mdContainer = document.createElement("div");
              mdContainer.className = "markdown";
              mdContainer.innerHTML = marked.parse(text);
              // Replace whatever is inside bodyWrapper with rendered markdown
              sectionInfo.bodyWrapper.innerHTML = "";
              sectionInfo.bodyWrapper.appendChild(mdContainer);
            } else {
              // Plain text / code file
              sectionInfo.codeEl.textContent = text;
            }
          } catch (err) {
            fileSections[i].codeEl.textContent =
              "Error loading this file:\n" + err.message;
          }

          loaded++;
          setStatus("Loaded " + loaded + " / " + files.length + " files…");
        }

        setStatus("All files loaded.");
      } catch (err) {
        console.error(err);
        const errorBox = document.createElement("div");
        errorBox.className = "error";
        errorBox.textContent =
          "Error loading repository contents: " +
          err.message +
          " (GitHub API rate limits or network issues can cause this.)";
        contentEl.prepend(errorBox);
        setStatus("Failed to load.");
      }
    }

    init();
  </script>
</body>
</html>
